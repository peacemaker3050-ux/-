<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>University Library Bot</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <style>
        /* === Reset & Basic Settings === */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            background-color: #121212;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #ffffff;
        }

        :root {
            --bg-color: #0f0f0f;
            --header-bg: #17212b;
            --chat-bg: #0e1621;
            --msg-in: #182533;
            --msg-out: #2b5278;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --accent-color: #3390ec;
            --btn-bg: rgba(255, 255, 255, 0.05);
            --btn-hover: rgba(51, 144, 236, 0.15);
            --btn-border: rgba(255, 255, 255, 0.1);
            --file-dummy-bg: rgba(255, 85, 85, 0.1);
            --file-dummy-text: #ff8888;
            --menu-bg: #1d2938;
            --modal-bg: rgba(0, 0, 0, 0.85);
        }

        * { box-sizing: border-box; }

        /* === Main Container === */
        .app-container {
            width: 100%;
            max-width: 500px; 
            height: 100%; 
            margin: 0 auto;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* === Header === */
        header {
            background-color: var(--header-bg);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #000;
            z-index: 20; 
            flex-shrink: 0; 
        }

        .header-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        
        .bot-avatar {
            width: 42px; height: 42px; 
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex; justify-content: center; align-items: center;
            font-size: 22px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px solid transparent;
        }

        .bot-name h2 { 
            font-size: 16px; margin: 0; font-weight: 600; line-height: 1.2; 
        }
        .bot-status { 
            font-size: 13px; color: var(--text-secondary); margin-top: 2px; display: block; 
        }

        .header-actions { 
            color: var(--accent-color); 
            font-size: 24px; 
            padding: 5px 10px; 
            cursor: pointer; 
            user-select: none;
        }

        /* === Options Menu (Dropdown) === */
        .menu-dropdown {
            position: absolute;
            top: 55px;
            right: 10px;
            width: 200px;
            background-color: var(--menu-bg);
            border: 1px solid #000;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            z-index: 100;
            overflow: hidden;
        }

        .menu-dropdown.active { display: flex; }

        .menu-item {
            padding: 12px 15px;
            cursor: pointer;
            color: #fff;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .menu-item:hover { background-color: rgba(255,255,255,0.1); }
        .menu-item.danger { color: #ff6b6b; }
        .menu-item.admin { color: #4dabf7; font-weight: bold; }

        /* === Admin Modal === */
        .admin-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-bg);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        .admin-modal.active { display: flex; }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #333;
        }
        .modal-title { font-size: 18px; font-weight: bold; color: #fff; }
        .close-modal { font-size: 24px; color: #fff; cursor: pointer; }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 14px; }
        .form-input, .form-textarea {
            width: 100%; padding: 10px;
            background: rgba(255,255,255,0.1); border: 1px solid #444;
            border-radius: 6px; color: #fff; outline: none;
            font-family: inherit;
        }
        .form-textarea { height: 60px; resize: vertical; }
        .form-input:focus { border-color: var(--accent-color); }

        .admin-section-title {
            color: var(--accent-color); margin-top: 25px; margin-bottom: 10px;
            font-size: 16px; border-bottom: 1px solid #333; padding-bottom: 5px;
        }

        .btn-save {
            width: 100%; padding: 12px;
            background-color: var(--accent-color);
            color: #fff; border: none; border-radius: 6px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            margin-top: 20px;
        }
        .btn-save:active { transform: scale(0.98); }

        .admin-list { margin-top: 20px; }
        .admin-item {
            background: rgba(255,255,255,0.05);
            padding: 10px; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .admin-name { font-size: 14px; }
        .btn-remove { 
            background: #ff4444; color: #fff; border: none; 
            padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; 
        }

        /* === Chat Area === */
        #chat-area {
            flex: 1; 
            min-height: 0; 
            padding: 15px;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: var(--chat-bg);
            background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            scroll-behavior: smooth;
        }

        #chat-area::-webkit-scrollbar { width: 6px; }
        #chat-area::-webkit-scrollbar-track { background: transparent; }
        #chat-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* === Messages === */
        .message {
            width: fit-content;
            max-width: 85%; 
            padding: 10px 14px;
            border-radius: 12px;
            position: relative;
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            word-break: break-word;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        @keyframes popIn { 
            from { opacity: 0; transform: scale(0.9) translateY(10px); } 
            to { opacity: 1; transform: scale(1) translateY(0); } 
        }

        .msg-bot { 
            align-self: flex-start; 
            background-color: var(--msg-in); 
            color: var(--text-primary); 
            border-bottom-left-radius: 4px; 
        } 
        
        .msg-user { 
            align-self: flex-end; 
            background-color: var(--msg-out); 
            color: var(--text-primary); 
            border-bottom-right-radius: 4px; 
        } 

        .msg-bot b { color: #fff; font-weight: 600; }

        /* === Timestamp Position === */
        .timestamp {
            font-size: 11px; color: rgba(255,255,255,0.5);
            text-align: right; 
            display: block; 
            margin-top: 4px; 
            margin-bottom: 0;
            float: none;
            clear: both;
            user-select: none;
        }

        /* === File Attachments === */
        .file-link-btn {
            display: flex; align-items: center; gap: 10px;
            background-color: rgba(0,0,0,0.2); padding: 10px;
            border-radius: 8px; text-decoration: none; 
            color: var(--accent-color);
            margin-top: 5px; border: 1px solid rgba(51, 144, 236, 0.3);
            font-size: 14px; cursor: pointer;
            transition: background 0.2s;
            overflow-wrap: break-word;
        }
        .file-link-btn:hover { background-color: rgba(51, 144, 236, 0.1); }

        .file-link-dummy {
            display: flex; align-items: center; gap: 10px;
            background-color: var(--file-dummy-bg); padding: 10px;
            border-radius: 8px; color: var(--file-dummy-text);
            margin-top: 5px; border: 1px solid rgba(255, 85, 85, 0.3);
            font-size: 14px;
        }

        /* === Typing Indicator === */
        .typing-indicator { 
            font-size: 12px; color: var(--text-secondary); 
            margin-left: 15px; margin-bottom: 5px; 
            display: none; font-style: italic; opacity: 0.8;
            flex-shrink: 0;
        } 
        .typing-indicator.active { display: block; }

        /* === Keyboard Area === */
        #keyboard-area {
            background-color: var(--header-bg);
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            border-top: 1px solid #000;
            min-height: 0; 
            max-height: 40vh;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .keyboard-btn {
            background-color: var(--btn-bg);
            border: 1px solid var(--btn-border);
            color: var(--text-primary);
            padding: 11px 8px; 
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 14px; 
            user-select: none;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            text-align: center;
            line-height: 1.3; 
            position: relative;
            overflow: hidden; 
            min-height: 48px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .keyboard-btn:hover { background-color: var(--btn-hover); }
        .keyboard-btn:active { transform: scale(0.97); background-color: rgba(255,255,255,0.1); }

        /* Back button special style */
        .keyboard-btn.back-btn {
            grid-column: span 2;
            background-color: rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.05);
            color: var(--text-secondary);
        }

        /* === FIX: Mobile Adjustments === */
        @media (max-width: 480px) {
            .keyboard-btn {
                font-size: 13px; 
                padding: 12px 6px; 
                line-height: 1.4; 
                min-height: 44px;
            }
        }
        
        @media (max-width: 350px) {
            #keyboard-area { grid-template-columns: 1fr; }
            .keyboard-btn.back-btn { grid-column: span 1; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="header-info">
            <div class="bot-avatar" id="header-avatar">ğŸ“</div>
            <div class="bot-name">
                <h2 id="header-name">University Bot</h2>
                <span class="bot-status" id="header-status">Online</span>
            </div>
        </div>
        
        <!-- Menu Trigger -->
        <div class="header-actions" id="menu-btn" title="Menu">â‹®</div>

        <!-- Dropdown Menu -->
        <div class="menu-dropdown" id="menu-dropdown">
            <div class="menu-item admin" onclick="checkAdmin()">
                <span>âš™ï¸</span> <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Admin)</span>
            </div>
            <div class="menu-item" onclick="clearChat()">
                <span>ğŸ—‘ï¸</span> <span>Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª</span>
            </div>
            <div class="menu-item danger" onclick="resetBot()">
                <span>ğŸ </span> <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©</span>
            </div>
        </div>
    </header>

    <div id="chat-area"></div>
    <div class="typing-indicator" id="typing">typing...</div>
    <div id="keyboard-area"></div>
</div>

<!-- Admin Modal -->
<div class="admin-modal" id="admin-modal">
    <div class="modal-header">
        <div class="modal-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª (Owner)</div>
        <div class="close-modal" onclick="closeAdminPanel()">Ã—</div>
    </div>

    <!-- 1. Basic Settings -->
    <div class="admin-section-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
    
    <div class="form-group">
        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª</label>
        <input type="text" id="admin-bot-name" class="form-input" placeholder="University Library Bot">
    </div>

    <div class="form-group">
        <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø© (Status) - Ø£Ø³ÙÙ„ Ø§Ù„Ø§Ø³Ù…</label>
        <input type="text" id="admin-bot-status" class="form-input" placeholder="Online">
    </div>

    <div class="form-group">
        <label class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)</label>
        <input type="text" id="admin-bot-img" class="form-input" placeholder="https://...">
    </div>

    <!-- 2. Chat Responses -->
    <div class="admin-section-title">Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>
    <div style="font-size:10px; color:#777; margin-bottom:10px;">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… {name} Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ø¯ÙƒØªÙˆØ± Ùˆ {botName} Ù„Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª.</div>

    <div class="form-group">
        <label class="form-label">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨</label>
        <textarea id="admin-msg-welcome" class="form-textarea"></textarea>
    </div>

    <div class="form-group">
        <label class="form-label">Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© (Subject)</label>
        <textarea id="admin-msg-subject" class="form-textarea"></textarea>
    </div>

    <div class="form-group">
        <label class="form-label">Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙƒØªÙˆØ± (Doctor)</label>
        <textarea id="admin-msg-doctor" class="form-textarea"></textarea>
    </div>

    <div class="form-group">
        <label class="form-label">Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Sections)</label>
        <textarea id="admin-msg-category" class="form-textarea"></textarea>
    </div>

    <div class="form-group">
        <label class="form-label">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù…Ø§Ø¯Ø© (Back to Subject)</label>
        <textarea id="admin-msg-back-subject" class="form-textarea"></textarea>
    </div>

    <div class="form-group">
        <label class="form-label">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¯ÙƒØªÙˆØ± (Back to Doctor)</label>
        <textarea id="admin-msg-back-doctor" class="form-textarea"></textarea>
    </div>

    <div class="form-group">
        <label class="form-label">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</label>
        <textarea id="admin-msg-back-main" class="form-textarea"></textarea>
    </div>

    <!-- 3. Admins -->
    <div class="admin-section-title">Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</div>
    <div class="form-group">
        <label class="form-label">Ø¥Ø¶Ø§ÙØ© Admin (Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/Ø§Ù„Ø¢ÙŠØ¯ÙŠ)</label>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="admin-add-input" class="form-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ali123">
            <button class="btn-save" style="width: auto; margin: 0;" onclick="addAdmin()">+</button>
        </div>
    </div>

    <div class="admin-list" id="admin-list-container">
        <!-- Admins will appear here -->
    </div>

    <button class="btn-save" onclick="saveAdminSettings()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
</div>

<script>
    // ============================================================
    // === CONFIGURATION (Read from LocalStorage first) ===
    // ============================================================
    
    const STORAGE_KEY = 'unibot_settings_v2';
    
    const defaultConfig = {
        botName: "University Library Bot",
        botStatus: "Online",
        botIcon: "ğŸ“", 
        botImage: "", 
        typingSpeed: 600,
        admins: ["owner"],
        // Chat Responses with Placeholders
        welcomeMessage: "Welcome! ğŸ“<br>This is <b>{botName}</b>.<br>Please select a subject to begin.",
        subjectPrompt: "<b>{name}</b>\nPlease select a Doctor ğŸ‘‡",
        doctorPrompt: "<b>{name}</b>\nSelect a section ğŸ‘‡",
        categoryPrompt: "<b>{name}</b> list:",
        backSubject: "Back to <b>{name}</b> doctors:",
        backDoctor: "Back to <b>{name}</b> sections:",
        backMain: "Back to Main Menu."
    };

    function loadConfig() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            return { ...defaultConfig, ...JSON.parse(saved) };
        }
        return defaultConfig;
    }

    let CONFIG = loadConfig();

    // Helper to replace placeholders
    function replacePlaceholders(text, name) {
        let res = text || "";
        if (name) {
            res = res.replace(/{name}/g, name);
        }
        res = res.replace(/{botName}/g, CONFIG.botName);
        return res;
    }

    // ============================================================
    // === DATABASE (Offline Version) ===
    // ============================================================
    
    const database = {
        "Physics": {
            "doctors": ["Dr. Ahmed", "Dr. Mahmoud"],
            "Dr. Ahmed": {
                "sections": ["ğŸ“š Lectures", "ğŸ“„ Sheets"],
                "ğŸ“š Lectures": [
                    { name: "Chapter 1 Explanation.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 2 Explanation.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 3 Explanation.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 4 Explanation.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 5 Explanation.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 6 Explanation.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 7 Explanation.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 8 Explanation.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 9 Explanation.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 10 Explanation.pdf", link: "javascript:void(0)" }
                ],
                "ğŸ“„ Sheets": [
                    { name: "Experiment Sheet 1.pdf", link: "javascript:void(0)" },
                    { name: "Experiment Sheet 2.pdf", link: "javascript:void(0)" },
                    { name: "Experiment Sheet 3.pdf", link: "javascript:void(0)" },
                    { name: "Experiment Sheet 4.pdf", link: "javascript:void(0)" },
                    { name: "Experiment Sheet 5.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Mahmoud": {
                "sections": ["ğŸ“š Lectures", "ğŸ“– References"],
                "ğŸ“š Lectures": [
                    { name: "Equations Lecture 1.pdf", link: "javascript:void(0)" },
                    { name: "Equations Lecture 2.pdf", link: "javascript:void(0)" },
                    { name: "Motion Lecture.pdf", link: "javascript:void(0)" },
                    { name: "Forces Lecture.pdf", link: "javascript:void(0)" },
                    { name: "Energy Lecture.pdf", link: "javascript:void(0)" }
                ],
                "ğŸ“– References": [
                    { name: "Chapter 1 Review.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 2 Review.pdf", link: "javascript:void(0)" },
                    { name: "Final Review.pdf", link: "javascript:void(0)" }
                ]
            }
        },
        "Chemistry": {
            "doctors": ["Dr. Saeed", "Dr. Mona"],
            "Dr. Saeed": {
                "sections": ["ğŸ“š Lectures", "ğŸ“„ Sheets"],
                "ğŸ“š Lectures": [
                    { name: "Organic Chemistry Intro.pdf", link: "javascript:void(0)" },
                    { name: "Carbon and Reactions.pdf", link: "javascript:void(0)" },
                    { name: "Hydrocarbons.pdf", link: "javascript:void(0)" },
                    { name: "Alcohols.pdf", link: "javascript:void(0)" },
                    { name: "Aldehydes.pdf", link: "javascript:void(0)" },
                    { name: "Ketones.pdf", link: "javascript:void(0)" },
                    { name: "Carboxylic Acids.pdf", link: "javascript:void(0)" },
                    { name: "Esters.pdf", link: "javascript:void(0)" },
                    { name: "Amines.pdf", link: "javascript:void(0)" },
                    { name: "Complex Reactions.pdf", link: "javascript:void(0)" }
                ],
                "ğŸ“„ Sheets": [
                    { name: "Reactions Sheet 1.pdf", link: "javascript:void(0)" },
                    { name: "Reactions Sheet 2.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Mona": {
                "sections": ["ğŸ“š Lectures"],
                "ğŸ“š Lectures": [
                    { name: "Analytical Chemistry 1.pdf", link: "javascript:void(0)" },
                    { name: "Analytical Chemistry 2.pdf", link: "javascript:void(0)" },
                    { name: "Analytical Chemistry 3.pdf", link: "javascript:void(0)" }
                ]
            }
        },
        "Mathematics": {
            "doctors": ["Dr. Kamel", "Dr. Samy", "Dr. Rami"],
            "Dr. Kamel": {
                "sections": ["ğŸ“š Lectures"],
                "ğŸ“š Lectures": [
                    { name: "Differentiation - Functions.pdf", link: "javascript:void(0)" },
                    { name: "Differentiation - Limits.pdf", link: "javascript:void(0)" },
                    { name: "Differentiation - Derivatives.pdf", link: "javascript:void(0)" },
                    { name: "Integration - Intro.pdf", link: "javascript:void(0)" },
                    { name: "Integration - Methods.pdf", link: "javascript:void(0)" },
                    { name: "Integration - Areas.pdf", link: "javascript:void(0)" },
                    { name: "Linear Algebra 1.pdf", link: "javascript:void(0)" },
                    { name: "Linear Algebra 2.pdf", link: "javascript:void(0)" },
                    { name: "Linear Algebra 3.pdf", link: "javascript:void(0)" },
                    { name: "Differential Equations.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Samy": {
                "sections": ["ğŸ“„ Sheets"],
                "ğŸ“„ Sheets": [
                    { name: "Problems Sheet 1.pdf", link: "javascript:void(0)" },
                    { name: "Problems Sheet 2.pdf", link: "javascript:void(0)" },
                    { name: "Problems Sheet 3.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Rami": {
                "sections": ["âœ… Solutions"],
                "âœ… Solutions": [
                    { name: "Problems Sheet 1 Solution.pdf", link: "javascript:void(0)" },
                    { name: "Problems Sheet 2 Solution.pdf", link: "javascript:void(0)" }
                ]
            }
        },
        "Biology": {
            "doctors": ["Dr. Laila", "Dr. Omar"],
            "Dr. Laila": {
                "sections": ["ğŸ“š Lectures", "ğŸ“– References"],
                "ğŸ“š Lectures": [
                    { name: "Cell and Tissues.pdf", link: "javascript:void(0)" },
                    { name: "Digestive System.pdf", link: "javascript:void(0)" },
                    { name: "Respiratory System.pdf", link: "javascript:void(0)" },
                    { name: "Circulatory System.pdf", link: "javascript:void(0)" },
                    { name: "Nervous System.pdf", link: "javascript:void(0)" },
                    { name: "Excretory System.pdf", link: "javascript:void(0)" },
                    { name: "Genetics 1.pdf", link: "javascript:void(0)" },
                    { name: "Genetics 2.pdf", link: "javascript:void(0)" },
                    { name: "Genetics 3.pdf", link: "javascript:void(0)" },
                    { name: "Evolution.pdf", link: "javascript:void(0)" }
                ],
                "ğŸ“– References": [
                    { name: "General Biology Summary.pdf", link: "javascript:void(0)" },
                    { name: "Previous Exams.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Omar": {
                "sections": ["ğŸ“„ Sheets"],
                "ğŸ“„ Sheets": [
                    { name: "Practical Sheet 1.pdf", link: "javascript:void(0)" },
                    { name: "Practical Sheet 2.pdf", link: "javascript:void(0)" },
                    { name: "Anatomy Sheet.pdf", link: "javascript:void(0)" }
                ]
            }
        },
        "Geology": {
            "doctors": ["Dr. Hany", "Dr. Tareq"],
            "Dr. Hany": {
                "sections": ["ğŸ“š Lectures"],
                "ğŸ“š Lectures": [
                    { name: "Earth Science Intro.pdf", link: "javascript:void(0)" },
                    { name: "Minerals and Rocks 1.pdf", link: "javascript:void(0)" },
                    { name: "Minerals and Rocks 2.pdf", link: "javascript:void(0)" },
                    { name: "Earthquakes and Volcanoes.pdf", link: "javascript:void(0)" },
                    { name: "Folding and Faulting.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Tareq": {
                "sections": ["ğŸ“– References"],
                "ğŸ“– References": [
                    { name: "Sedimentary Rocks Review.pdf", link: "javascript:void(0)" },
                    { name: "Igneous Rocks Review.pdf", link: "javascript:void(0)" },
                    { name: "Metamorphic Rocks Review.pdf", link: "javascript:void(0)" },
                    { name: "Geological Time Review.pdf", link: "javascript:void(0)" },
                    { name: "Egypt Geological History Review.pdf", link: "javascript:void(0)" },
                    { name: "Final Exam Model.pdf", link: "javascript:void(0)" },
                    { name: "Exam Model Solution.pdf", link: "javascript:void(0)" },
                    { name: "Very Important Questions.pdf", link: "javascript:void(0)" },
                    { name: "Geological Laws.pdf", link: "javascript:void(0)" },
                    { name: "Geological Maps.pdf", link: "javascript:void(0)" }
                ]
            }
        },
        "English": {
            "doctors": ["Dr. Sarah", "Dr. Ali", "Dr. Noha"],
            "Dr. Sarah": {
                "sections": ["ğŸ“š Lectures"],
                "ğŸ“š Lectures": [
                    { name: "Unit 1 - Family & Friends.pdf", link: "javascript:void(0)" },
                    { name: "Unit 2 - Daily Routine.pdf", link: "javascript:void(0)" },
                    { name: "Unit 3 - Food & Drink.pdf", link: "javascript:void(0)" },
                    { name: "Unit 4 - At Airport.pdf", link: "javascript:void(0)" },
                    { name: "Unit 5 - Holidays.pdf", link: "javascript:void(0)" },
                    { name: "Unit 6 - Technology.pdf", link: "javascript:void(0)" },
                    { name: "Unit 7 - Health.pdf", link: "javascript:void(0)" },
                    { name: "Unit 8 - Education.pdf", link: "javascript:void(0)" },
                    { name: "Unit 9 - Work.pdf", link: "javascript:void(0)" },
                    { name: "Unit 10 - The Environment.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Ali": {
                "sections": ["ğŸ—£ï¸ Vocabulary"],
                "ğŸ—£ï¸ Vocabulary": [
                    { name: "Vocabulary List Unit 1-3.pdf", link: "javascript:void(0)" },
                    { name: "Vocabulary List Unit 4-6.pdf", link: "javascript:void(0)" },
                    { name: "Vocabulary List Unit 7-10.pdf", link: "javascript:void(0)" },
                    { name: "Idioms and Phrases.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Noha": {
                "sections": ["âœ… Grammar"],
                "âœ… Grammar": [
                    { name: "Grammar: Present Simple.pdf", link: "javascript:void(0)" },
                    { name: "Grammar: Present Continuous.pdf", link: "javascript:void(0)" },
                    { name: "Grammar: Past Simple.pdf", link: "javascript:void(0)" },
                    { name: "Grammar: Past Continuous.pdf", link: "javascript:void(0)" },
                    { name: "Grammar: Future Forms.pdf", link: "javascript:void(0)" },
                    { name: "Grammar: Conditionals.pdf", link: "javascript:void(0)" }
                ]
            }
        }
    };

    // ============================================================
    // === APP LOGIC ===
    // ============================================================

    const subjects = Object.keys(database);
    let currentSubject = null;
    let currentDoctor = null;
    let currentCategory = null;

    const chatArea = document.getElementById('chat-area');
    const keyboardArea = document.getElementById('keyboard-area');
    const typingIndicator = document.getElementById('typing');
    const menuBtn = document.getElementById('menu-btn');
    const menuDropdown = document.getElementById('menu-dropdown');
    
    const adminModal = document.getElementById('admin-modal');
    const adminNameInput = document.getElementById('admin-bot-name');
    const adminStatusInput = document.getElementById('admin-bot-status');
    const adminImgInput = document.getElementById('admin-bot-img');
    const adminAddInput = document.getElementById('admin-add-input');
    const adminListContainer = document.getElementById('admin-list-container');

    // New Response Inputs
    const respWelcome = document.getElementById('admin-msg-welcome');
    const respSubject = document.getElementById('admin-msg-subject');
    const respDoctor = document.getElementById('admin-msg-doctor');
    const respCategory = document.getElementById('admin-msg-category');
    const respBackSubject = document.getElementById('admin-msg-back-subject');
    const respBackDoctor = document.getElementById('admin-msg-back-doctor');
    const respBackMain = document.getElementById('admin-msg-back-main');

    function addMessage(content, sender, isHtml = false) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');
        msgDiv.classList.add(sender === 'bot' ? 'msg-bot' : 'msg-user');

        if (isHtml) {
            msgDiv.innerHTML = content;
        } else {
            msgDiv.innerText = content;
        }

        const timeSpan = document.createElement('span');
        timeSpan.classList.add('timestamp');
        timeSpan.innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        msgDiv.appendChild(timeSpan);

        chatArea.appendChild(msgDiv);
        scrollToBottom();
    }

    function scrollToBottom() {
        requestAnimationFrame(() => {
             chatArea.scrollTop = chatArea.scrollHeight;
        });
    }

    function botReply(text, isHtml = false) {
        typingIndicator.classList.add('active');
        scrollToBottom();
        setTimeout(() => {
            typingIndicator.classList.remove('active');
            addMessage(text, 'bot', isHtml);
        }, CONFIG.typingSpeed);
    }

    function createButton(text, onClick, isBack = false) {
        const btn = document.createElement('div');
        btn.classList.add('keyboard-btn');
        if(isBack) btn.classList.add('back-btn');
        btn.innerText = text;
        btn.onclick = onClick;
        return btn;
    }

    // --- Menu Logic ---

    menuBtn.addEventListener('click', (e) => {
        e.stopPropagation(); 
        menuDropdown.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
        if (!menuDropdown.contains(e.target) && e.target !== menuBtn) {
            menuDropdown.classList.remove('active');
        }
    });

    // 1. Clear Chat
    window.clearChat = function() {
        chatArea.innerHTML = '';
        resetStateVariables();
        closeMenu();
        
        setTimeout(() => {
            botReply("Chat cleared. ğŸ§¹<br>Welcome back! Choose a subject ğŸ‘‡", true);
        }, 100);
    }

    // 2. Reset Bot
    window.resetBot = function() {
        resetStateVariables();
        closeMenu();
        addMessage("ğŸ  Back to Main Menu", 'user');
        botReply("Bot restarted. Please select a subject ğŸ‘‡", true);
    }

    // --- Admin Logic ---

    function closeMenu() {
        menuDropdown.classList.remove('active');
    }

    window.checkAdmin = function() {
        closeMenu();
        const password = prompt("Please enter Admin Password:");
        if (password === "1234") {
            openAdminPanel();
        } else if (password !== null) {
            alert("âŒ Wrong Password!");
        }
    }

    function openAdminPanel() {
        adminNameInput.value = CONFIG.botName;
        adminStatusInput.value = CONFIG.botStatus;
        adminImgInput.value = CONFIG.botImage || "";
        
        // Fill Response Inputs
        respWelcome.value = CONFIG.welcomeMessage;
        respSubject.value = CONFIG.subjectPrompt;
        respDoctor.value = CONFIG.doctorPrompt;
        respCategory.value = CONFIG.categoryPrompt;
        respBackSubject.value = CONFIG.backSubject;
        respBackDoctor.value = CONFIG.backDoctor;
        respBackMain.value = CONFIG.backMain;
        
        renderAdminList();
        adminModal.classList.add('active');
    }

    window.closeAdminPanel = function() {
        adminModal.classList.remove('active');
    }

    function renderAdminList() {
        adminListContainer.innerHTML = '';
        if (!CONFIG.admins || CONFIG.admins.length === 0) {
            adminListContainer.innerHTML = '<div style="color:#777; font-size:13px;">No admins added yet.</div>';
            return;
        }

        CONFIG.admins.forEach((admin, index) => {
            const div = document.createElement('div');
            div.className = 'admin-item';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'admin-name';
            nameSpan.innerText = admin;

            if (admin !== 'owner') {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove';
                removeBtn.innerText = 'Ø­Ø°Ù';
                removeBtn.onclick = () => removeAdmin(index);
                div.appendChild(nameSpan);
                div.appendChild(removeBtn);
            } else {
                div.appendChild(nameSpan);
                div.innerHTML += '<span style="color:#4dabf7; font-size:12px;"> (Owner)</span>';
            }

            adminListContainer.appendChild(div);
        });
    }

    window.addAdmin = function() {
        const name = adminAddInput.value.trim();
        if (name) {
            if (!CONFIG.admins) CONFIG.admins = [];
            if (!CONFIG.admins.includes(name)) {
                CONFIG.admins.push(name);
                adminAddInput.value = '';
                renderAdminList();
            } else {
                alert("Admin already exists!");
            }
        }
    }

    window.removeAdmin = function(index) {
        if (confirm("Are you sure you want to remove this admin?")) {
            CONFIG.admins.splice(index, 1);
            renderAdminList();
        }
    }

    window.saveAdminSettings = function() {
        CONFIG.botName = adminNameInput.value.trim() || defaultConfig.botName;
        CONFIG.botStatus = adminStatusInput.value.trim() || defaultConfig.botStatus;
        CONFIG.botImage = adminImgInput.value.trim();

        // Save Messages
        CONFIG.welcomeMessage = respWelcome.value;
        CONFIG.subjectPrompt = respSubject.value;
        CONFIG.doctorPrompt = respDoctor.value;
        CONFIG.categoryPrompt = respCategory.value;
        CONFIG.backSubject = respBackSubject.value;
        CONFIG.backDoctor = respBackDoctor.value;
        CONFIG.backMain = respBackMain.value;
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(CONFIG));

        // Apply Visual Changes
        document.querySelector('#header-name').innerText = CONFIG.botName;
        document.querySelector('#header-status').innerText = CONFIG.botStatus;

        const avatarEl = document.querySelector('#header-avatar');
        
        if (CONFIG.botImage && CONFIG.botImage.trim() !== "") {
            avatarEl.style.backgroundImage = `url('${CONFIG.botImage}')`;
            avatarEl.innerText = ""; 
        } else {
            avatarEl.style.backgroundImage = "none";
            avatarEl.innerText = CONFIG.botIcon;
        }

        alert("âœ… Settings Saved! Changes will apply to new messages.");
        closeAdminPanel();
    }

    function resetStateVariables() {
        currentSubject = null;
        currentDoctor = null;
        currentCategory = null;
        renderKeyboard();
    }

    function renderKeyboard() {
        keyboardArea.innerHTML = '';

        if (!currentSubject) {
            subjects.forEach(sub => {
                keyboardArea.appendChild(createButton(sub, () => handleSubjectClick(sub)));
            });
            return;
        }

        keyboardArea.appendChild(createButton("ğŸ”™ Back", goBack, true));

        if (currentSubject && !currentDoctor) {
            const subjectDoctors = database[currentSubject].doctors;
            subjectDoctors.forEach(doc => {
                keyboardArea.appendChild(createButton(doc, () => handleDoctorClick(doc)));
            });
        } else if (currentSubject && currentDoctor && !currentCategory) {
            const doctorSections = database[currentSubject][currentDoctor].sections;
            doctorSections.forEach(cat => {
                keyboardArea.appendChild(createButton(cat, () => handleCategoryClick(cat)));
            });
        } else if (currentSubject && currentDoctor && currentCategory) {
            const fileList = database[currentSubject][currentDoctor][currentCategory] || [];
            if (fileList.length > 0) {
                fileList.forEach(file => {
                    keyboardArea.appendChild(createButton(file.name, () => handleFileClick(file)));
                });
            } else {
                const emptyBtn = createButton("âŒ No files available", () => {});
                emptyBtn.style.opacity = "0.5"; 
                emptyBtn.style.cursor = "default";
                keyboardArea.appendChild(emptyBtn);
            }
        }
    }

    function handleSubjectClick(subjectName) {
        addMessage(subjectName, 'user');
        currentSubject = subjectName; 
        currentDoctor = null; 
        currentCategory = null;
        
        const msg = replacePlaceholders(CONFIG.subjectPrompt, subjectName);
        botReply(msg, true);
        renderKeyboard();
    }

    function handleDoctorClick(doctorName) {
        addMessage(doctorName, 'user');
        currentDoctor = doctorName;
        currentCategory = null;

        const msg = replacePlaceholders(CONFIG.doctorPrompt, doctorName);
        botReply(msg, true);
        renderKeyboard();
    }

    function handleCategoryClick(categoryName) {
        addMessage(categoryName, 'user');
        currentCategory = categoryName;

        const msg = replacePlaceholders(CONFIG.categoryPrompt, categoryName);
        botReply(msg, true);
        renderKeyboard();
    }

    function handleFileClick(fileObj) {
        addMessage(`Open: ${fileObj.name}`, 'user');
        
        setTimeout(() => {
            if (!fileObj.link || fileObj.link.startsWith("javascript:")) {
                const htmlContent = `
                    <div style="margin-bottom:5px;">ğŸ“ <b>${fileObj.name}</b></div>
                    <div class="file-link-dummy">
                        <span>âš ï¸</span><span>Link not configured</span>
                    </div>`;
                addMessage(htmlContent, 'bot', true);
            } else {
                const htmlContent = `
                    <div style="margin-bottom:5px;">ğŸ“ <b>${fileObj.name}</b></div>
                    <a href="${fileObj.link}" target="_blank" class="file-link-btn">
                        <span>ğŸ“‚</span><span>Download / Open File</span>
                    </a>`;
                addMessage(htmlContent, 'bot', true);
            }
        }, 800);
    }

    function goBack() {
        addMessage("ğŸ”™ Back", 'user');
        
        if (currentCategory) {
            currentCategory = null;
            const msg = replacePlaceholders(CONFIG.backDoctor, currentDoctor);
            botReply(msg, true);
        } else if (currentDoctor) {
            currentDoctor = null;
            const msg = replacePlaceholders(CONFIG.backSubject, currentSubject);
            botReply(msg, true);
        } else if (currentSubject) {
            currentSubject = null;
            botReply(CONFIG.backMain, true);
        }
        renderKeyboard();
    }

    // --- Initialization ---

    window.onload = () => {
        document.querySelector('#header-name').innerText = CONFIG.botName;
        document.querySelector('#header-status').innerText = CONFIG.botStatus;
        const avatarEl = document.querySelector('#header-avatar');
        
        if (CONFIG.botImage && CONFIG.botImage.trim() !== "") {
            avatarEl.style.backgroundImage = `url('${CONFIG.botImage}')`;
            avatarEl.innerText = ""; 
        } else {
            avatarEl.innerText = CONFIG.botIcon;
        }

        setTimeout(() => {
            const welcomeMsg = replacePlaceholders(CONFIG.welcomeMessage, null);
            botReply(welcomeMsg, true);
            renderKeyboard();
        }, 500);
    };

    // ============================================================
    // === PWA SERVICE WORKER REGISTRATION ===
    // ============================================================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker: Registered'))
          .catch(err => console.log('Service Worker: Error: ' + err));
      });
    }

</script>
</body>
</html>